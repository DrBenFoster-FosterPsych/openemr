
<!-- UPLOAD STYLE.CSS -->
<link rel="stylesheet" href="/interface/forms/psychotherapy_progress_note/style.css?v={{ "now"|date("U") }}">

<div class="container-fluid oe-form">
  <form method="post" action="{{ action }}" class="oe-form oe-custom-form form-horizontal">
   
    <input type="hidden" name="id" value="{{ form.id|default('') }}">
    <input type="hidden" name="pid" value="{{ pid }}">
    <input type="hidden" name="encounter" value="{{ encounter }}">
    <input type="hidden" name="csrf_token_form" value="{{ csrf_token }}">

    <!-- ======================== -->
    <!-- General Block -->
    <!-- ======================== -->
    <h3 class="form-section-header">General</h3>

    <label class="form-label">Subjective</label>
    <textarea name="subjective">{{ form.subjective }}</textarea>

    <label class="form-label">Objective</label>
    <textarea name="objective">{{ form.objective }}</textarea>

    <!-- ======================== -->
    <!-- Mental Status Exam Block -->
    <!-- ======================== -->
    <h3 class="form-section-header">Mental Status Exam</h3>

    {% set mental_status_fields = {
      'orientation': ['AOx1','AOx2','AOx3','AOx4'],
      'attention': ['WNL','Somnolent','Lethargic','Obtunded','Stupor','Comatose','Selective Attention','Confused','Delirium'],
      'appearance': ['WNL','Disheveled','Unkempt'],
      'behavior': ['WNL','Inappropriate Eye Contact','Decreased Movement','Physically Threatening','Increased Movement'],
      'speech': ['WNL','Abnormal Rate','Abnormal Volume','Flattened Prosody','Delayed','Pressured','Hyperverbal'],
      'affect': ['WNL','Incongruent','Restricted','Blunted','Flat','Labile'],
      'mood': ['WNL','Euthymic','Heightened','Elevated','Expansive','Euphoric','Dysthymic','Dysphoric','Depressed','Anxious','Irritable','Angry'],
      'thought_process': ['WNL','Circumstantial','Concrete','Ruminative','Perseverative','Tangential','Disorganized','Internal Preoccupation','Blocking'],
      'thought_content': ['WNL','Auditory Hallucinations','Visual Hallucinations','Delusions','Ideas of Reference','Poverty of Content','Obsessions','Paranoid Ideation'],
      'judgment': ['WNL','Fair','Poor','Impaired'],
      'insight': ['WNL','Fair','Poor','Impaired']
    } %}

    {% for field, options in mental_status_fields %}
      <label class="form-label">{{ field|replace({'_':' '})|capitalize }}</label>
      <div class="checkbox-group">
        {% for opt in options %}
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              name="{{ field }}[]"
              value="{{ opt }}"
              id="{{ field }}_{{ loop.index }}"
              {% if opt in attribute(form, field) %}checked{% endif %}
            >
            <label class="form-check-label" for="{{ field }}_{{ loop.index }}">
              {{ opt }}
            </label>
          </div>
        {% endfor %}
      </div>
    {% endfor %}

    <!-- ======================== -->
    <!-- Risk Assessment Block    -->
    <!-- ======================== -->
    <h3 class="form-section-header">Risk Assessment</h3>

    <!-- Denies all risk -->
    <div class="risk-check">
      <input
        type="checkbox"
        class="risk-check-input"
        id="denies_all_risk"
        name="denies_all_risk"
        value="1"
        {% if form.denies_all_risk == 1 %}checked{% endif %}
        onclick="toggleRiskFields()"
      >
      <label class="risk-check-label" for="denies_all_risk">
        Client currently denies all risk
      </label>
    </div>

    <!-- Collapsible content -->
    <div id="risk-fields" {% if form.denies_all_risk == 1 %}style="display:none;"{% endif %}>

      <!-- Suicide Risk Level -->
      <label class="form-label">Suicide Risk Level</label>
      <div class="checkbox-group">
        {% set suicide_options = ['None','Low','Moderate','High'] %}
        {% for opt in suicide_options %}
          <label class="form-check-label">
            <input
             class="form-check-input"
              type="checkbox"
              name="suicide_level[]"
              value="{{ opt }}"
              {% if opt in form.suicide_level %}checked{% endif %}
            >
            {{ opt }}
          </label>
        {% endfor %}
      </div>

      <!-- Homicide Risk Level -->
      <label class="form-label">Homicide Risk Level</label>
      <div class="checkbox-group">
        {% set homicide_options = ['None','Low','Moderate','High'] %}
        {% for opt in homicide_options %}
          <label class="form-check-label">
            <input
              class="form-check-input"
              type="checkbox"
              name="homicide_level[]"
              value="{{ opt }}"
              {% if opt in form.homicide_level %}checked{% endif %}
            >
            {{ opt }}
          </label>
        {% endfor %}
      </div>

      <!-- Self-Harm Risk Level -->
      <label class="form-label">Self-Harm Risk Level</label>
      <div class="checkbox-group">
        {% set selfharm_options = ['None','Low','Moderate','High'] %}
        {% for opt in selfharm_options %}
          <label class="form-check-label">
            <input
              class="form-check-input"
              type="checkbox"
              name="selfharm_level[]"
              value="{{ opt }}"
              {% if opt in form.selfharm_level %}checked{% endif %}
            >
            {{ opt }}
          </label>
        {% endfor %}
      </div>

      <!-- Additional Relevant Information -->
      <label class="form-label">Additional Relevant Information</label>
      <textarea name="risk_info" rows="3">{{ form.risk_info }}</textarea>
    </div>

   <!-- Overall Risk -->
    <label class="form-label">Overall Risk</label>
    <select class="form-control" name="overall_risk">
      {% set overall_options = ['None','Low','Moderate','High'] %}
      {% for opt in overall_options %}
        <option value="{{ opt }}" {% if form.overall_risk == opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>

    <script>
      function toggleRiskFields() {
        const checkbox = document.getElementById('denies_all_risk');
        const fields = document.getElementById('risk-fields');
        fields.style.display = checkbox.checked ? 'none' : 'block';
      }
    </script>


    <!-- ======================== -->
    <!-- Assessment Block -->
    <!-- ======================== -->
    <h3 class="form-section-header">Assessment</h3>

    {% set assessment_fields = [
      'clinical_summary','diagnostic_support','assessment_symptoms','medical_necessity','therapeutic_interventions'
    ] %}

    {% for field in assessment_fields %}
      <label class="form-label">{{ field|replace({'_':' '})|capitalize }}</label>
      {% if field == 'assessment_symptoms' %}
        <select class="form-control" name="Assessment of symptom level">
          {% for opt in ['Escalated','Maintained','Improved'] %}
            <option value="{{ opt }}" {% if form.assessment_symptoms == opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      {% else %}
          <textarea name="{{ field }}">{{ attribute(form, field) }}</textarea>
      {% endif %}
    {% endfor %}

    <!-- ======================== -->
    <!-- Progress Towards Goals Block -->
    <!-- ======================== -->
    <h3 class="form-section-header">Progress Towards Goals</h3>

    <!-- Treatment Goals -->
    <label class="form-label">Description of Treatment Goals</label>
    <textarea name="treatment_goals">{{ form.treatment_goals }}</textarea>

    <!-- Overall Progress Towards Goals -->
    <label class="form-label">Overall Progress Towards Goals</label>
    <select class="form-control" name="goals_progress">
      {% set goals_options = ['Progressed','Regressed','No Change','Goals Achieved'] %}
      {% for opt in goals_options %}
        <option value="{{ opt }}" {% if form.goals_progress == opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>

    <!-- Barriers to treatment goals -->
    <label class="form-label">Barriers to treatment</label>
    <div class="checkbox-group">
      {% set barriers_options = ['Severe mental health symptoms', 'Lack of motivation', 'Difficulty with emotion regulation', 'External stressors/situational factors', 'Limited social support', 'Lack of insight into condition', 'Limited access to needed services', 'Co-occurring medical issues', 'Cultural and/or linguistic barriers', 'Substance use'] %}
      {% for opt in barriers_options %}
        <label class="form-check-label">
          <input
            class="form-check-input"
            type="checkbox"
            name="barriers[]"
            value="{{ opt }}"
            {% if opt in form.barriers %}checked{% endif %}
          >
          {{ opt }}
        </label>
       {% endfor %}
    </div>

    <!-- ======================== -->
    <!-- Plan Block -->
    <!-- ======================== -->
    <h3 class="form-section-header">Plan</h3>
    {% set plan_fields = [
      ['next_steps','Next Steps'],
      ['next_appt_date','Date of Next Appointment'],
      ['next_appt_time','Time of Next Appointment']
    ] %}

    {% for item in plan_fields %}
      {% set field = item[0] %}
      {% set label = item[1] %}
      <label class="form-label">{{ label }}</label>
      {% if field == 'next_steps' %}
          <textarea name="{{ field }}">{{ attribute(form, field) }}</textarea>
      {% elseif field == 'next_appt_date' %}
        <input class="form-control" type="date" name="{{ field }}" value="{{ attribute(form, field) }}">
      {% else %}
        <input class="form-control" type="time" name="{{ field }}" value="{{ attribute(form, field) }}">
      {% endif %}
    {% endfor %}

    <br><br>
    <button type="submit" class="btn btn-primary">Save Progress Note</button>
  </form>
</div>